MACRO (MYPACKAGETESTEXECUTABLE name)
  IF (MYPACKAGE_DEBUG)
    FOREACH (_source ${ARGN})
      MESSAGE (STATUS "[${PROJECT_NAME}-TESTEXECUTABLE-DEBUG] Source: ${_source}")
    ENDFOREACH ()
  ENDIF ()

  FOREACH (_name ${name} ${name}_static)
    LIST (APPEND ${PROJECT_NAME}_TEST_EXECUTABLE ${_name})
    IF (MYPACKAGE_DEBUG)
      MESSAGE (STATUS "[${PROJECT_NAME}-TESTEXECUTABLE-DEBUG] Adding ${_name}")
    ENDIF ()
    ADD_EXECUTABLE (${_name} EXCLUDE_FROM_ALL ${ARGN})
    IF (MYPACKAGE_DEBUG)
      MESSAGE (STATUS "[${PROJECT_NAME}-TESTEXECUTABLE-DEBUG] Set runtime output directory of ${_name} to ${LIBRARY_OUTPUT_PATH}")
    ENDIF ()
    SET_TARGET_PROPERTIES (${_name} PROPERTIES RUNTIME_OUTPUT_DIRECTORY ${LIBRARY_OUTPUT_PATH})
	IF (TARGET ${PROJECT_NAME}_config_test)
      IF (MYPACKAGE_DEBUG)
        MESSAGE (STATUS "[${PROJECT_NAME}-TESTEXECUTABLE-DEBUG] Adding ${PROJECT_NAME}_config_test dependency to target ${_name}")
      ENDIF ()
      ADD_DEPENDENCIES(${_name} ${PROJECT_NAME}_config_test)
	  IF (MYPACKAGE_DEBUG)
		MESSAGE (STATUS "[${PROJECT_NAME}-TESTEXECUTABLE-DEBUG] Adding PRIVATE ${CMAKE_CURRENT_BINARY_DIR} dependency to target ${_name}")
	  ENDIF ()
	  TARGET_INCLUDE_DIRECTORIES(${_name} PRIVATE $<${build_local_interface}:${CMAKE_CURRENT_BINARY_DIR}>)
	  IF (EXISTS ${CMAKE_CURRENT_BINARY_DIR}/test)
		  IF (MYPACKAGE_DEBUG)
			MESSAGE (STATUS "[${PROJECT_NAME}-TESTEXECUTABLE-DEBUG] Adding PRIVATE ${CMAKE_CURRENT_BINARY_DIR}/test dependency to target ${_name}")
		  ENDIF ()
		  TARGET_INCLUDE_DIRECTORIES(${_name} PRIVATE $<${build_local_interface}:${CMAKE_CURRENT_BINARY_DIR}/test>)
	  ENDIF ()
	ENDIF ()

    IF (_name STREQUAL ${name})
      IF (TARGET ${PROJECT_NAME})
        IF (MYPACKAGE_DEBUG)
          MESSAGE (STATUS "[${PROJECT_NAME}-TESTEXECUTABLE-DEBUG] Adding ${PROJECT_NAME} link library to ${_name}")
        ENDIF ()
        TARGET_LINK_LIBRARIES(${_name} PUBLIC ${PROJECT_NAME})
	  ELSE ()
        #
        # Current project does not define a library
        #
        IF (MYPACKAGE_DEBUG)
          MESSAGE (STATUS "[${PROJECT_NAME}-TESTEXECUTABLE-DEBUG] Adding PUBLIC output/include include directories to ${_name}")
        ENDIF ()
	    TARGET_INCLUDE_DIRECTORIES (${_name} PUBLIC $<${build_local_interface}:output/include include>)
      ENDIF ()
	ENDIF ()

    IF (_name STREQUAL ${name}_static)
      IF (TARGET ${PROJECT_NAME}_static)
        IF (MYPACKAGE_DEBUG)
          MESSAGE (STATUS "[${PROJECT_NAME}-TESTEXECUTABLE-DEBUG] Adding ${PROJECT_NAME}_static link library to ${_name}")
        ENDIF ()
        TARGET_LINK_LIBRARIES(${_name} PUBLIC ${PROJECT_NAME}_static)
	  ELSE ()
        #
        # Current project does not define a library
        #
        IF (MYPACKAGE_DEBUG)
          MESSAGE (STATUS "[${PROJECT_NAME}-TESTEXECUTABLE-DEBUG] Setting -D${PROJECT_NAME}_STATIC to ${_name}")
        ENDIF ()
        TARGET_COMPILE_DEFINITIONS(${_name} PUBLIC -D${PROJECT_NAME}_STATIC)
        IF (MYPACKAGE_DEBUG)
          MESSAGE (STATUS "[${PROJECT_NAME}-TESTEXECUTABLE-DEBUG] Adding PUBLIC output/include include directories to ${_name}")
        ENDIF ()
	    TARGET_INCLUDE_DIRECTORIES (${_name} PUBLIC $<${build_local_interface}:output/include include>)
      ENDIF ()
    ENDIF ()
  ENDFOREACH ()
ENDMACRO()
